<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotizador Industrial Maestro</title>
    <style>
        :root { --p: #2c3e50; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 420px; }
        h2 { text-align: center; color: var(--p); border-bottom: 2px solid #eee; padding-bottom: 15px; }
        label { display: block; margin-top: 15px; font-weight: 600; color: #444; }
        select { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: white; }
        button { width: 100%; padding: 18px; margin-top: 25px; background: var(--p); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #1a252f; }
        #resultado { margin-top: 25px; padding: 20px; background: #e8f5e9; border-radius: 15px; display: none; text-align: center; border: 1px solid #c8e6c9; }
        .monto { font-size: 36px; color: #2e7d32; font-weight: 800; display: block; margin: 10px 0; }
        .detalles { font-size: 12px; color: #555; text-align: left; border-top: 1px solid #c8e6c9; padding-top: 10px; margin-top: 10px; line-height: 1.6; }
    </style>
</head>
<body>

<div class="card">
    <h2>Cotizador Industrial</h2>
    
    <label>Material:</label>
    <select id="mat">
        <option value="carbon">Acero al Carbón</option>
        <option value="inox">Acero Inoxidable</option>
    </select>

    <label>Calibre:</label>
    <select id="cal">
        <option value="10">Calibre 10</option>
        <option value="12">Calibre 12</option>
        <option value="14">Calibre 14</option>
        <option value="16">Calibre 16</option>
        <option value="18">Calibre 18</option>
        <option value="20">Calibre 20</option>
        <option value="22">Calibre 22</option>
    </select>

    <label>Tamaño de Lámina:</label>
    <select id="dim">
        <option value="3.05">1.22m x 3.05m</option>
        <option value="2.44">1.22m x 2.44m</option>
    </select>

    <button id="btn" onclick="calcular()">CALCULAR PRECIO FINAL</button>

    <div id="resultado">
        <small style="font-weight: bold; color: #1b5e20;">PRECIO FINAL DE VENTA</small>
        <span class="monto" id="txtPrecio">$ 0.00</span>
        <div class="detalles" id="txtDetalle"></div>
    </div>
</div>

<script>
    // REEMPLAZA CON TU ID DE LA IMAGEN
    const SHEET_ID = '1eF0T2m9M9v7R8E-U8j6w6Yk2u6Z5W6v6_V6u6L6_W6Y'; 
    const SHEET_NAME = 'Hoja 1';

    async function calcular() {
        const btn = document.getElementById('btn');
        const resDiv = document.getElementById('resultado');
        btn.innerText = "Sincronizando con Excel...";
        btn.disabled = true;

        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
            const resp = await fetch(url + "&nocache=" + Date.now());
            const csv = await resp.text();
            
            // Limpieza profunda de datos para evitar el error de "no encontrado"
            const filas = csv.split('\n').map(r => r.split(',').map(c => c.replace(/^"|"$/g, '').trim()));

            const matSel = document.getElementById('mat').value;
            const calSel = document.getElementById('cal').value.replace(/\D/g, ""); 
            const dimSel = parseFloat(document.getElementById('dim').value);

            // Buscamos la fila comparando solo números limpios
            const d = filas.find(f => f[0] == calSel);

            if (!d) {
                throw new Error(`No se encontró el Calibre ${calSel} en la columna A. Revisa que en el Excel diga exactamente ${calSel}.`);
            }

            // Lectura de variables globales (G=6, H=7, I=8, J=9, K=10)
            const flete     = parseFloat(filas[1][6]) || 0;
            const moMin     = parseFloat(filas[1][7]) || 0;
            const utilidad  = parseFloat(filas[1][8]) || 1;
            const provMult  = parseFloat(filas[1][9]) || 1;  // Factor Proveedor
            const distMult  = parseFloat(filas[1][10]) || 1; // Factor Distribuidor

            // Precios por material
            let precioBase = (matSel === 'inox') ? parseFloat(d[2]) : parseFloat(d[1]);
            const tiempo   = parseFloat(d[3]) || 0;
            const factorGas = parseFloat(d[4]) || 0;
            const gasTanque = (matSel === 'inox') ? 2600 : 1200;

            // --- CÁLCULO EN CASCADA ---
            // 1. Ajuste de tamaño y factor proveedor
            let matFinal = (dimSel === 2.44) ? (precioBase * (2.44 / 3.05)) : precioBase;
            let costoMatTotal = matFinal * provMult;

            // 2. Costos de transformación
            let costoGas = gasTanque * factorGas;
            let costoMO  = tiempo * moMin;

            // 3. Precio Final: (Producción + Flete) * Utilidad * Distribuidor
            let costoProduccion = costoMatTotal + costoGas + costoMO + flete;
            let precioVenta = costoProduccion * utilidad * distMult;

            // Mostrar resultados
            resDiv.style.display = 'block';
            document.getElementById('txtPrecio').innerText = "$ " + precioVenta.toLocaleString('es-MX', {minimumFractionDigits: 2});
            document.getElementById('txtDetalle').innerHTML = `
                <b>Desglose de Costos:</b><br>
                • Lámina (c/Prov): $${costoMatTotal.toLocaleString('es-MX')}<br>
                • Corte: $${costoMO.toLocaleString('es-MX')} | Gas: $${costoGas.toLocaleString('es-MX')}<br>
                • Flete: $${flete.toLocaleString('es-MX')}<br>
                <hr>
                <small>Factores: Utilidad x${utilidad} | Distribuidor x${distMult}</small>
            `;

        } catch (e) {
            alert("AVISO: " + e.message);
        } finally {
            btn.innerText = "CALCULAR PRECIO FINAL";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
